<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HCC Calculator — Child-Pugh / ALBI / BCLC</title>
<style>
  :root{
    --bg:#0b0c10; --fg:#e8e8e8; --muted:#b7b7b7;
    --card:#14161b; --accent:#5fb3f8; --accent-2:#66d9a3; --warn:#ffd166;
    --good:#2ecc71; --mid:#f1c40f; --bad:#e74c3c; --border:#2a2f37;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f7f9fc; --fg:#111; --muted:#444; --card:#ffffff; --accent:#1976d2; --accent-2:#0a8754; --warn:#e6b800; --border:#dfe5ef; }
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; line-height:1.35}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:12px 16px;z-index:10}
  header h1{margin:0;font-size:18px}
  main{max-width:1000px;margin:16px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:860px){ .grid{grid-template-columns: 1fr 1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px}
  .card h2{margin:0 0 8px 0;font-size:18px}
  .row{display:grid;grid-template-columns:1.3fr 1fr 0.9fr;gap:8px;align-items:center;margin-bottom:8px}
  .row label{font-size:14px;color:var(--muted)}
  .row input[type="number"], .row select{
    width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--fg);
    -webkit-appearance:none;appearance:none
  }
  .row small{color:var(--muted)}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:600;border:1px solid var(--border);font-size:12px}
  .out{display:flex;flex-wrap:wrap;gap:8px}
  .out .k{color:var(--muted);min-width:100px}
  .out .v{font-weight:700}
  .pill{padding:8px 10px;border-radius:8px;border:1px solid var(--border);display:flex;justify-content:space-between;gap:8px}
  .good{background:rgba(46,204,113,.12);border-color:rgba(46,204,113,.35)}
  .mid{background:rgba(241,196,15,.12);border-color:rgba(241,196,15,.35)}
  .bad{background:rgba(231,76,60,.12);border-color:rgba(231,76,60,.35)}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  button{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--fg);cursor:pointer}
  button.primary{background:var(--accent);border-color:transparent;color:white}
  .footer{color:var(--muted);font-size:12px;margin-top:12px}
  .muted{color:var(--muted)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .section-title{display:flex;align-items:center;gap:8px;margin:0 0 8px}
  .section-title .badge{background:rgba(95,179,248,.12);border-color:rgba(95,179,248,.35)}
  .table{width:100%;border-collapse:collapse;font-size:14px}
  .table th,.table td{border:1px solid var(--border);padding:6px 8px;text-align:left}
  .table th{background:rgba(95,179,248,.12)}
  .hl{background:rgba(102,217,163,.12)}
</style>
</head>
<body>
  <header><h1>HCC Calculator — Child‑Pugh • ALBI • BCLC</h1></header>
  <main>
    <div class="card">
      <h2 class="section-title"><span class="badge">Inputs</span> Patient & Tumor</h2>
      <div class="row">
        <label>Total Bilirubin</label>
        <input id="biliVal" type="number" step="0.01" min="0" value="1.8">
        <select id="biliUnit">
          <option>mg/dL</option>
          <option>μmol/L</option>
        </select>
      </div>
      <div class="row">
        <label>Albumin</label>
        <input id="albVal" type="number" step="0.01" min="0" value="3.6">
        <select id="albUnit">
          <option>g/dL</option>
          <option>g/L</option>
        </select>
      </div>
      <div class="row">
        <label>INR</label>
        <input id="inr" type="number" step="0.01" min="0" value="1.2">
        <select disabled><option>ratio</option></select>
      </div>
      <div class="row">
        <label>Ascites</label>
        <select id="ascites">
          <option>None</option>
          <option>Mild</option>
          <option>Moderate–Severe</option>
        </select>
        <small>Clinical assessment</small>
      </div>
      <div class="row">
        <label>Hepatic Encephalopathy</label>
        <select id="enceph">
          <option>None</option>
          <option>I–II</option>
          <option>III–IV</option>
        </select>
        <small>West Haven</small>
      </div>
      <div class="row">
        <label>ECOG Performance Status</label>
        <select id="ecog">
          <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option>
        </select>
        <small>0 best → 4 worst</small>
      </div>
      <div class="row">
        <label>Number of Tumor Nodules</label>
        <input id="nodules" type="number" step="1" min="0" value="1">
        <select disabled><option>count</option></select>
      </div>
      <div class="row">
        <label>Largest Tumor Size</label>
        <input id="sizeVal" type="number" step="0.1" min="0" value="2.5">
        <select id="sizeUnit">
          <option>cm</option>
          <option>mm</option>
        </select>
      </div>
      <div class="row">
        <label>Portal Vein Invasion</label>
        <select id="pvi"><option>No</option><option>Yes</option></select>
        <small>Macrovascular invasion</small>
      </div>
      <div class="row" style="margin-bottom:0">
        <label>Extrahepatic Metastasis</label>
        <select id="ehs"><option>No</option><option>Yes</option></select>
        <small>Any extrahepatic spread</small>
      </div>
      <div class="actions">
        <button id="calcBtn">Calculate</button>
        <button class="primary" id="resetBtn">Reset</button>
        <button id="shareBtn">Copy state link</button>
      </div>
      <div id="calcTime" class="footer muted" style="margin-top:4px"></div>
      <div class="footer">Units auto‑convert internally (μmol/L↔mg/dL, g/L↔g/dL, mm↔cm). Calculations update instantly.</div>
      <div class="footer" id="lastCalc">Last calculated: —</div>
    </div>

    <div class="grid">
      <div class="card">
        <h2 class="section-title"><span class="badge">Child‑Pugh</span> Score & Class</h2>
        <div class="out">
          <div class="pill" id="cp-bili"><span class="k">Bilirubin (mg/dL)</span><span class="v mono" id="cpBiliVal">—</span></div>
          <div class="pill" id="cp-alb"><span class="k">Albumin (g/dL)</span><span class="v mono" id="cpAlbVal">—</span></div>
          <div class="pill"><span class="k">INR</span><span class="v mono" id="cpInrVal">—</span></div>
          <div class="pill"><span class="k">Ascites</span><span class="v mono" id="cpAscVal">—</span></div>
          <div class="pill"><span class="k">Encephalopathy</span><span class="v mono" id="cpEncVal">—</span></div>
        </div>
        <table class="table" style="margin-top:8px">
          <thead><tr><th>Component</th><th>Score</th></tr></thead>
          <tbody>
            <tr><td>Bilirubin</td><td class="mono" id="cpBiliScore">—</td></tr>
            <tr><td>Albumin</td><td class="mono" id="cpAlbScore">—</td></tr>
            <tr><td>INR</td><td class="mono" id="cpInrScore">—</td></tr>
            <tr><td>Ascites</td><td class="mono" id="cpAscScore">—</td></tr>
            <tr><td>Encephalopathy</td><td class="mono" id="cpEncScore">—</td></tr>
            <tr class="hl"><td><b>Total</b></td><td class="mono" id="cpTotal">—</td></tr>
            <tr class="hl"><td><b>Class</b></td><td class="mono" id="cpClass">—</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <h2 class="section-title"><span class="badge">ALBI</span> Score & Grade</h2>
        <div class="out">
          <div class="pill"><span class="k">Bilirubin (μmol/L)</span><span class="v mono" id="albiBiliUM">—</span></div>
          <div class="pill"><span class="k">Albumin (g/L)</span><span class="v mono" id="albiAlbGL">—</span></div>
        </div>
        <table class="table" style="margin-top:8px">
          <tbody>
            <tr><td>ALBI score</td><td class="mono" id="albiScore">—</td></tr>
            <tr class="hl"><td>ALBI grade</td><td class="mono" id="albiGrade">—</td></tr>
            <tr><td>Grade 2 subclass</td><td class="mono" id="albiSub">—</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2 class="section-title"><span class="badge">BCLC</span> Stage (approximate)</h2>
      <div class="out" style="margin-bottom:8px">
        <div class="pill"><span class="k">Child‑Pugh</span><span class="v mono" id="bclcCp">—</span></div>
        <div class="pill"><span class="k">ECOG</span><span class="v mono" id="bclcEcog">—</span></div>
        <div class="pill"><span class="k">Nodules</span><span class="v mono" id="bclcNod">—</span></div>
        <div class="pill"><span class="k">Largest size (cm)</span><span class="v mono" id="bclcSize">—</span></div>
        <div class="pill"><span class="k">PVI</span><span class="v mono" id="bclcPvi">—</span></div>
        <div class="pill"><span class="k">EHS</span><span class="v mono" id="bclcEhs">—</span></div>
      </div>
      <div class="pill" id="bclcStagePill"><span><b>Stage</b></span><span class="v mono" id="bclcStage">—</span></div>

      <h3 style="margin:12px 0 6px">Quick reference (not prescriptive)</h3>
      <table class="table">
        <thead><tr><th>BCLC</th><th>Typical options</th></tr></thead>
        <tbody>
          <tr><td>0</td><td>Curative resection, local ablation</td></tr>
          <tr><td>A</td><td>Curative resection, local ablation, transplantation</td></tr>
          <tr><td>B</td><td>Transarterial chemoembolization (TACE)</td></tr>
          <tr><td>C</td><td>Systemic therapy (e.g., ICI/targeted)</td></tr>
          <tr><td>D</td><td>Best supportive care / palliative</td></tr>
        </tbody>
      </table>
    </div>

    <div class="footer">
      Formulas: Child‑Pugh uses bilirubin (mg/dL), albumin (g/dL), INR, ascites, encephalopathy. 
      ALBI score = log10(bilirubin μmol/L)·0.66 + albumin(g/L)·(‑0.0852). 
      BCLC rules are pragmatic approximations for 0/A/B/C/D using CP class, ECOG, tumor burden, and invasion/spread.
    </div>
  </main>

<script>
function getNum(id){ const v = parseFloat(document.getElementById(id).value); return isNaN(v)? 0 : v; }
function text(id){ return document.getElementById(id).value; }
function fmt(x, d=2){ if (isNaN(x)) return "—"; return Number(x).toFixed(d); }

\1
  // Update "last calculated" timestamp at the end of compute()

  // Read inputs
  let bili = getNum('biliVal'); const biliU = text('biliUnit'); // mg/dL or μmol/L
  let alb  = getNum('albVal');  const albU  = text('albUnit');  // g/dL or g/L
  const inr = getNum('inr');
  const asc = text('ascites');
  const enc = text('enceph');
  const ecog = parseInt(text('ecog'), 10);
  const nod  = parseInt(getNum('nodules'), 10);
  let size = getNum('sizeVal'); const sizeU = text('sizeUnit'); // cm or mm
  const pvi = text('pvi'); const ehs = text('ehs');

  // Normalize for scoring
  const bili_mgdl = (biliU === 'μmol/L') ? bili/17.1 : bili;
  const alb_gdl   = (albU  === 'g/L')    ? alb/10     : alb;
  const size_cm   = (sizeU === 'mm')     ? size/10    : size;

  // Show what we're using
  document.getElementById('cpBiliVal').textContent = fmt(bili_mgdl,2);
  document.getElementById('cpAlbVal').textContent  = fmt(alb_gdl,2);
  document.getElementById('cpInrVal').textContent  = fmt(inr,2);
  document.getElementById('cpAscVal').textContent  = asc;
  document.getElementById('cpEncVal').textContent  = enc;

  // Child-Pugh component scores
  const s_bili = (bili_mgdl < 2) ? 1 : (bili_mgdl <= 3 ? 2 : 3);
  const s_alb  = (alb_gdl >= 3.5) ? 1 : (alb_gdl >= 2.8 ? 2 : 3);
  const s_inr  = (inr < 1.7) ? 1 : (inr <= 2.3 ? 2 : 3);
  const s_asc  = (asc === 'None') ? 1 : (asc === 'Mild' ? 2 : 3);
  const s_enc  = (enc === 'None') ? 1 : (enc === 'I–II' ? 2 : 3);

  const cp_total = s_bili + s_alb + s_inr + s_asc + s_enc;
  const cp_class = (cp_total <= 6) ? 'A' : (cp_total <= 9 ? 'B' : 'C');

  document.getElementById('cpBiliScore').textContent = s_bili;
  document.getElementById('cpAlbScore').textContent  = s_alb;
  document.getElementById('cpInrScore').textContent  = s_inr;
  document.getElementById('cpAscScore').textContent  = s_asc;
  document.getElementById('cpEncScore').textContent  = s_enc;
  document.getElementById('cpTotal').textContent     = cp_total;
  document.getElementById('cpClass').textContent     = cp_class;

  // ALBI: convert to umol/L and g/L
  const bili_umol = bili_mgdl * 17.1;
  const alb_gL    = alb_gdl * 10;
  document.getElementById('albiBiliUM').textContent = fmt(bili_umol,1);
  document.getElementById('albiAlbGL').textContent  = fmt(alb_gL,1);

  const albi_score = Math.log10(Math.max(bili_umol, 1e-9)) * 0.66 + (alb_gL * -0.0852);
  let albi_grade, albi_sub;
  if (albi_score <= -2.60){ albi_grade = "1"; albi_sub = "N/A"; }
  else if (albi_score <= -2.27){ albi_grade = "2"; albi_sub = "2a"; }
  else if (albi_score <= -1.39){ albi_grade = "2"; albi_sub = "2b"; }
  else { albi_grade = "3"; albi_sub = "N/A"; }
  document.getElementById('albiScore').textContent = fmt(albi_score,2);
  document.getElementById('albiGrade').textContent = albi_grade;
  document.getElementById('albiSub').textContent   = albi_sub;

  // BCLC (approx)
  document.getElementById('bclcEcog').textContent = ecog;
  document.getElementById('bclcNod').textContent  = nod;
  document.getElementById('bclcSize').textContent = fmt(size_cm,1);
  document.getElementById('bclcPvi').textContent  = pvi;
  document.getElementById('bclcEhs').textContent  = ehs;
  document.getElementById('bclcCp').textContent   = cp_class;

  let bclc;
  if (cp_class === 'C' || ecog > 2) { bclc = 'D'; }
  else if (pvi === 'Yes' || ehs === 'Yes' || (ecog >=1 && ecog <=2)) { bclc = 'C'; }
  else if (ecog === 0 && (cp_class==='A'||cp_class==='B') && nod===1 && size_cm<2){ bclc='0'; }
  else if (ecog === 0 && (cp_class==='A'||cp_class==='B') && (nod===1 || (nod<=3 && size_cm<=3))){ bclc='A'; }
  else if (ecog === 0 && (cp_class==='A'||cp_class==='B') && pvi==='No' && ehs==='No'){ bclc='B'; }
  else { bclc='C'; }

  document.getElementById('bclcStage').textContent = bclc;
  const pill = document.getElementById('bclcStagePill');
  pill.classList.remove('good','mid','bad');
  pill.classList.add(bclc === '0' || bclc === 'A' ? 'good' : (bclc==='B' ? 'mid' : 'bad'));

  // Persist to hash for sharing
  const state = {
    bili, biliU, alb, albU, inr, asc, enc, ecog, nod, size, sizeU, pvi, ehs
  };
  window.history.replaceState(null, "", "#"+encodeURIComponent(JSON.stringify(state)));
  const tsEl = document.getElementById("lastCalc");
  if (tsEl) { tsEl.textContent = "Last calculated: " + new Date().toLocaleString(); }
  // Update timestamp
  const tsEl = document.getElementById('calcTime');
  if (tsEl){
    const now = new Date();
    tsEl.textContent = 'Last calculated at: ' + now.toLocaleString();
  }

}

function loadStateFromHash(){
  if (location.hash.length > 1){
    try{
      const s = JSON.parse(decodeURIComponent(location.hash.slice(1)));
      const set = (id,val)=>{ const el = document.getElementById(id); if (el) el.value = val; };
      set('biliVal', s.bili); set('biliUnit', s.biliU);
      set('albVal', s.alb); set('albUnit', s.albU);
      set('inr', s.inr);
      set('ascites', s.asc); set('enceph', s.enc);
      set('ecog', s.ecog);
      set('nodules', s.nod);
      set('sizeVal', s.size); set('sizeUnit', s.sizeU);
      set('pvi', s.pvi); set('ehs', s.ehs);
    }catch(e){ console.warn("Bad state in URL"); }
  }
}

function resetInputs(){
  document.getElementById('biliVal').value = 1.8;
  document.getElementById('biliUnit').value = 'mg/dL';
  document.getElementById('albVal').value = 3.6;
  document.getElementById('albUnit').value = 'g/dL';
  document.getElementById('inr').value = 1.2;
  document.getElementById('ascites').value = 'None';
  document.getElementById('enceph').value = 'None';
  document.getElementById('ecog').value = '0';
  document.getElementById('nodules').value = 1;
  document.getElementById('sizeVal').value = 2.5;
  document.getElementById('sizeUnit').value = 'cm';
  document.getElementById('pvi').value = 'No';
  document.getElementById('ehs').value = 'No';
  compute();
}

// Add both 'input' and 'change' listeners for iOS compatibility
document.querySelectorAll("input,select").forEach(el=>{
  el.addEventListener("input", compute, {passive:true});
  el.addEventListener("change", compute, {passive:true});
});
document.addEventListener("DOMContentLoaded", compute, {once:true});

document.getElementById("calcBtn").addEventListener("click", compute);
document.getElementById("resetBtn").addEventListener("click", resetInputs);
document.getElementById("shareBtn").addEventListener("click", ()=>{
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(location.href).then(()=>{
      alert("Link with current inputs copied to clipboard.");
    }, ()=>{ alert("Copy failed. You can share the URL after # manually."); });
  } else {
    prompt("Copy this URL:", location.href);
  }
});

loadStateFromHash();
compute();
</script>
</body>
</html>
